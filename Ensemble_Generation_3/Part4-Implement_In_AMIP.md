# Implementing the ensembling in the AMIP Suite

To implement the ensemble changes into the AMIP suite (which uses UM vn11.1 currently), first a set of dummy variables are needed in the vn11.1 source code. The set of code changes are generated by the python script [acure-codechange.py](acure-codechange.py), which generates 3 files, one each for the update module, the meta data conf file and the ukca_option_mod.F90 file, containing the necessary code changes for each of these files along with barebones instructions on where to paste the blocks of code in their respective files. The variable names are provided by a list in [acure.txt](acure.txt). A more detailed description of how to make namelist additions to a branch of the UM can be found [here](http://www.ukca.ac.uk/wiki/index.php/UKCA_Chemistry_and_Aerosol_vn10.9_Tutorial_11)

The changes made to the rose-meta.conf and rose-suite.conf files described in the previous section [here](../Part3-Extend_to_dataframe.md) were copied over into the AMIP versions of these files, as was the changes to the suite.rc file allowing non-sequential ensemble numbers and dataframes to be used.

To ensure that when ensembling is not required the suite will still run and PPE variables can be still set, a number of conditional statements have been included in the suite.rc file, as shown below:

```ini
{% if ENS_LOG %}
[[parameters]]
    ens = {{ ENS_COMB | join(', ') }}
{% endif %}

...

{% if SITE == 'archer' %}
[[queues]]
    [[[default]]]
        limit=28
{% endif %}

...

{% if ENS_LOG %}
{% set BUILD_GRAPH = BUILD_GRAPH ~ ' => perturb => atmos_main<ens>' if TASK_RUN else BUILD_GRAPH %}
{% else %}
{% set BUILD_GRAPH = BUILD_GRAPH ~ ' => atmos_main' if TASK_RUN else BUILD_GRAPH %}
{% endif %}

...

{% if ENS_LOG %}
{% set INIT_GRAPH = INIT_GRAPH ~ ' => perturb => atmos_main<ens>' if TASK_RUN else INIT_GRAPH %}
{% else %}
{% set INIT_GRAPH = INIT_GRAPH ~ ' => atmos_main' if TASK_RUN else INIT_GRAPH %}
{% endif %}

...

[[[ {{EXPT_RESUB}} ]]]
    {% if ENS_LOG %}
    graph = atmos_main<ens> => {{ RESUB_GRAPH }}
    {% else %}
    graph = atmos_main => {{ RESUB_GRAPH }}
    {% endif %}

{% if TASK_ARCH_WALL %}
[[[ R1//^+{{EXPT_RUNLEN}}-{{EXPT_RESUB}} ]]]
    {% if ENS_LOG %}
    graph = atmos_main<ens> => rose_arch_wallclock => housekeeping
    {% else %}
    graph = atmos_main => rose_arch_wallclock => housekeeping
    {% endif %}
{% endif %}

...

[[atmos_main]]
    inherit = RUN_MAIN, ATMOS_RESOURCE, ATMOS
    post-script = save_wallclock.sh {{EXPT_RESUB}}

[[atmos_main<ens>]]
    inherit = RUN_MAIN, ATMOS_RESOURCE, ATMOS
    post-script = save_wallclock.sh {{EXPT_RESUB}}
    [[[environment]]]
        ROSE_APP_OPT_CONF_KEYS = ens_${CYLC_TASK_PARAM_ens} {{CONFIG_OPT}} {{BITCOMP_NRUN_OPT}}
        DATAM=$ROSE_DATA/{{DATAM}}/ens_${CYLC_TASK_PARAM_ens}
        ENS_MEMBER=${CYLC_TASK_PARAM_ens}

```

These conditional statements ensure that if ensembling is not enabled, the suite will still run as normal with no extra settings required and still be able to read in the PPE variables as set in the GUI.


Work still pending includes:
* Checking to see if post processing can work with ensembling - this is of vital importance
* Testing with the AMIP suite
